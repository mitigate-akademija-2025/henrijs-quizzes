<%= form_with model: quiz do |f| %>
  <div class="mx-auto max-w-3xl">
    <section
      data-controller="nested"
      data-nested-index-value="<%= f.object.questions.size %>"
      class="relative overflow-hidden rounded-2xl border border-gray-200/70 bg-white/80 p-6 shadow-sm backdrop-blur supports-[backdrop-filter]:bg-white/60">

      <div class="pointer-events-none absolute inset-x-0 top-0 h-px bg-gradient-to-r from-blue-500/40 via-cyan-500/40 to-violet-500/40"></div>

      <header class="mb-6 flex items-center gap-3">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-blue-600/10 text-blue-700 ring-1 ring-inset ring-blue-600/20">
          <%= heroicon "sparkles", variant: :outline, options: { class: "h-4.5 w-4.5" } %>
        </span>
        <div>
          <h1 class="text-base font-semibold text-gray-900">
            <%= local_assigns[:title] %>
          </h1>
        
          <p class="text-xs text-gray-500"><%= local_assigns[:subtitle] %></p>
        </div>
      </header>

      <% if f.object.errors.any? %>
        <div class="mb-6 rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-800">
          <p class="font-medium">Please fix the following:</p>
          <ul class="mt-1 list-disc pl-5">
            <% f.object.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="space-y-6">
        <div class="space-y-1.5">
          <label class="text-base font-semibold text-gray-900">Title</label>
          <p class="text-xs text-gray-500">Provide a clear title for your quiz.</p>
          <%= f.text_field :title,
                placeholder: "Give your quiz a short, clear title",
                class: "w-full rounded-xl border border-gray-200 bg-white/90 px-3 py-2.5 shadow-sm
                        placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500" %>
        </div>

        <div class="space-y-1.5">
          <label class="text-base font-semibold text-gray-900">Description</label>
          <p class="text-xs text-gray-500">Provide a clear description for your quiz.</p>
          <%= f.text_area :description,
            rows: 3,
            placeholder: "Describe what the quiz is about",
            data: {
              controller: "autosize",
              action: "input->autosize#resize",
              autosize_min_rows_value: 3,
              autosize_max_rows_value: 14
            },
            class: "w-full rounded-xl border border-gray-200 bg-white/90 px-3 py-2.5 shadow-sm
                    placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500
                    resize-y" %>   
          <p class="text-xs text-gray-500">Keep it brief â€“ what will people learn or test?</p>
        </div>

        <div>
          <div class="mb-2 flex items-center justify-between">
            <h3 class="text-base font-semibold text-gray-900">Questions</h3>
          </div>

          <div id="questions" data-nested-target="list" class="mt-3 space-y-4">
            <%= f.fields_for :questions do |qf| %>
              <%= render "questions/fields", f: qf %>
            <% end %>
          </div>

          <!-- Choice template -->
        <template data-nested-target="choiceTemplate">
          <%= f.fields_for :questions, Question.build_for("ChoiceQuestion"), child_index: "NEW_Q" do |qf| %>
            <%= qf.hidden_field :type, value: "ChoiceQuestion" %>
            <%= render "questions/fields", f: qf, new_record: true, text_question: false %>
          <% end %>
        </template>

        <!-- Text template -->
        <template data-nested-target="textTemplate">
          <%= f.fields_for :questions, Question.build_for("TextQuestion"), child_index: "NEW_Q" do |qf| %>
            <%= qf.hidden_field :type, value: "TextQuestion" %>
            <%= render "questions/fields", f: qf, new_record: true, text_question: true %>
          <% end %>
        </template>
        </div>

        <div class="mt-6 flex flex-wrap items-center justify-end gap-2">
          <%= link_to "Cancel", quizzes_path,
                class: "inline-flex items-center rounded-xl border border-gray-200 bg-white px-3.5 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-400" %>

          <button type="button"
                  data-action="nested#addChoiceQuestion"
                  class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-3.5 py-2 text-sm font-medium text-white hover:bg-blue-700 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-blue-600 transition-colors">
            <%= heroicon "question-mark-circle", variant: :outline, options: { class: "h-4.5 w-4.5" } %>
            Add MCQ
          </button>

          <button type="button"
                  data-action="nested#addTextQuestion"
                  class="inline-flex items-center gap-2 rounded-xl bg-violet-600 px-3.5 py-2 text-sm font-medium text-white hover:bg-violet-700 focus-visible:outline focus-visible:outline-offset-2 focus-visible:outline-violet-600 transition-colors">
            <%= heroicon "chat-bubble-bottom-center-text", variant: :outline, options: { class: "h-4.5 w-4.5" } %>
            Add Text
          </button>

          <%= f.submit (f.object.persisted? ? "Save changes" : "Create quiz"),
                class: "cursor-pointer inline-flex items-center rounded-xl bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 transition-colors" %>
        </div>

      </div>
    </section>
  </div>
<% end %>
